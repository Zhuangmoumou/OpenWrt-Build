name: Build Static FFmpeg with RKMpp (ARM64)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    # 定义环境变量
    env:
      # 目标架构
      TARGET_ARCH: aarch64
      # 交叉编译工具链前缀
      TOOLCHAIN_PREFIX: aarch64-linux-gnu
      # 最终安装目录
      INSTALL_DIR: ${{ github.workspace }}/ffmpeg-install
      # MPP 静态库安装目录
      MPP_INSTALL_DIR: ${{ github.workspace }}/mpp-install
      # FFmpeg 源代码仓库
      FFMPEG_REPO: https://github.com/nyanmisaka/ffmpeg-rockchip.git
      # MPP 源代码仓库
      MPP_REPO: https://github.com/HermanChen/mpp.git
      # 静态编译所需的 pkg-config 路径
      PKG_CONFIG_PATH: ${{ github.workspace }}/mpp-install/lib/pkgconfig

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Install Cross-Compilation Toolchain and Dependencies
        run: |
          # 安装 ARM64 交叉编译工具链
          sudo apt update
          sudo apt install -y \
            g++-${{ env.TOOLCHAIN_PREFIX }} \
            gcc-${{ env.TOOLCHAIN_PREFIX }} \
            binutils-${{ env.TOOLCHAIN_PREFIX }} \
            libc6-dev-${{ env.TOOLCHAIN_PREFIX }} \
            
          # 安装编译依赖项 (宿主机)
          sudo apt install -y \
            build-essential \
            git \
            cmake \
            pkg-config \
            yasm \
            nasm \
            
          # 安装 FFmpeg 外部库的 ARM64 静态开发文件
          # 注意：这里假设 apt 仓库提供了这些库的静态版本 (.a)
          sudo apt install -y \
            libx264-dev:${{ env.TARGET_ARCH }} \
            libx265-dev:${{ env.TARGET_ARCH }} \
            libmp3lame-dev:${{ env.TARGET_ARCH }} \
            libdrm-dev:${{ env.TARGET_ARCH }} \
            libegl1-mesa-dev:${{ env.TARGET_ARCH }} \
            libgles2-mesa-dev:${{ env.TARGET_ARCH }} \
            libv4l2-dev:${{ env.TARGET_ARCH }} \
            libasound2-dev:${{ env.TARGET_ARCH }} \
            
          # 启用多架构支持
          sudo dpkg --add-architecture ${{ env.TARGET_ARCH }}
          sudo apt update
          
          # 确保 pkg-config 能够找到交叉编译的库
          export PKG_CONFIG_PATH=/usr/lib/${{ env.TOOLCHAIN_PREFIX }}/pkgconfig:/usr/local/lib/${{ env.TOOLCHAIN_PREFIX }}/pkgconfig

      - name: 1. Build and Install Static RKMpp
        run: |
          git clone ${{ env.MPP_REPO }} mpp_src
          cd mpp_src
          mkdir build && cd build
          
          # CMake 交叉编译工具链文件 (简化版)
          echo "set(CMAKE_SYSTEM_NAME Linux)" > toolchain.cmake
          echo "set(CMAKE_SYSTEM_PROCESSOR ${{ env.TARGET_ARCH }})" >> toolchain.cmake
          echo "set(CMAKE_C_COMPILER ${{ env.TOOLCHAIN_PREFIX }}-gcc)" >> toolchain.cmake
          echo "set(CMAKE_CXX_COMPILER ${{ env.TOOLCHAIN_PREFIX }}-g++)" >> toolchain.cmake
          
          # 编译 RKMpp 静态库
          cmake .. \
            -DCMAKE_TOOLCHAIN_FILE=toolchain.cmake \
            -DCMAKE_INSTALL_PREFIX=${{ env.MPP_INSTALL_DIR }} \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_SHARED_LIBS=OFF \
            -DBUILD_TEST=OFF
            
          make -j$(nproc)
          make install
          
          # 修正 pkg-config 路径，使其指向 MPP 静态库
          export PKG_CONFIG_PATH=${{ env.MPP_INSTALL_DIR }}/lib/pkgconfig:${{ env.PKG_CONFIG_PATH }}
          
      - name: 2. Build and Install Static FFmpeg
        run: |
          git clone ${{ env.FFMPEG_REPO }} ffmpeg_src
          cd ffmpeg_src
          
          # FFmpeg 静态配置命令
          ./configure \
            --prefix=${{ env.INSTALL_DIR }} \
            --cross-prefix=${{ env.TOOLCHAIN_PREFIX }}- \
            --target-os=linux \
            --arch=${{ env.TARGET_ARCH }} \
            --enable-gpl \
            --enable-version3 \
            --enable-nonfree \
            \
            --enable-static \
            --disable-shared \
            --disable-programs \
            --pkg-config-flags="--static" \
            \
            --enable-libx264 \
            --enable-libx265 \
            --enable-libmp3lame \
            --enable-rkmpp \
            --enable-rkrga \
            --enable-libdrm \
            --enable-egl \
            --enable-opengles \
            --enable-alsa \
            --enable-libv4l2 \
            \
            --disable-opencl \
            \
            --extra-cflags="-I${{ env.MPP_INSTALL_DIR }}/include -I/usr/include/x265" \
            --extra-ldflags="-L${{ env.MPP_INSTALL_DIR }}/lib -L/usr/lib/${{ env.TOOLCHAIN_PREFIX }}" \
            --extra-libs="-lx265 -lstdc++ -lm"
            
          make -j$(nproc)
          make install

      - name: 3. Package the installed FFmpeg
        run: |
          cd ${{ github.workspace }}
          tar -czvf ffmpeg-arm64-static-rkmpp.tar.gz ffmpeg-install

      - name: 4. Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-arm64-static-rkmpp
          path: ${{ github.workspace }}/ffmpeg-arm64-static-rkmpp.tar.gz
